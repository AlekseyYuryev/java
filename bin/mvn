#!/bin/sh
#

# Parse the arguments.
ARGS=""
while [ $# != 0 ]; do
	flag="$1"
	case "$flag" in
		-ut) UPDATE_TEMPLATES=true
			shift;
			continue;
			;;
		--update-templates) UPDATE_TEMPLATES=true
			shift;
			continue;
			;;
		--help) HELP=true
			;;
	esac
	ARGS="$ARGS $1"
	shift
done

# Find all pom*-template.xml files and write them to pom.xml.
TEMPLATES="`find * -name 'pom*-template.xml'`"
#echo $TEMPLATES
for TEMPLATE in $TEMPLATES; do
	POM="`echo $TEMPLATE | sed 's/-template//'`"
	if [ ! -f $POM ] || [ $TEMPLATE -nt $POM ] || [ `which mvn` -nt $POM ]; then
		cat $TEMPLATE |
		sed 's/\${orgVersion}/1.2.13/' | \
		sed 's/\${commonsVersion}/0.4.2/' | \
		sed 's/\${xmlVersion}/1.0.4/' | \
		sed 's/\${webVersion}/0.5.6/' > $POM
		echo "Updated: $POM"
	fi
done

# Now do a backwards climb to check and update all parent poms.
FILE="`ls pom*-template.xml 2> /dev/null`"
if [ $FILE ]; then
	RELATIVE_PATH="../"
	if [ "`cat $FILE | grep relativePath`" ]; then
		RELATIVE_PATH="`cat $FILE | sed 's/<relativePath>//' | sed 's/<\/relativePath>//' | sed 's/[^\.^\/]//g'`"
	fi
	CWD="`pwd`"
	cd $RELATIVE_PATH
	mvn -ut
	cd $CWD
fi

# If we only want to update from the templates, then exit now.
if [ $UPDATE_TEMPLATES ]; then
	exit 0;
fi

# Find the original mvn script.
MVN="`which -a mvn | xargs echo | awk '{print $NF}'`"

# Get help from the original mvn and then print our additional options.
if [ $HELP ]; then
	$MVN $ARGS
	echo
	echo "Additional options:"
	echo " -ut,--update-templates        Update POM files from POM-TEMPLATE files."
	exit
fi

$MVN $ARGS
